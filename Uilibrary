local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")

local Library = {}
Library.__index = Library

-- Arredondamento
local function Roundify(obj, rad)
	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0, rad or 8)
	corner.Parent = obj
end

-- Draggable
local function MakeDraggable(frame)
	local dragging = false
	local dragInput, dragStart, startPos

	frame.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 or input.Touch then
			dragging = true
			dragStart = input.Position
			startPos = frame.Position
			input.Changed:Connect(function()
				if input.UserInputState == Enum.UserInputState.End then
					dragging = false
				end
			end)
		end
	end)

	UserInputService.InputChanged:Connect(function(input)
		if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
			local delta = input.Position - dragStart
			frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
		end
	end)
end

local Themes = {
	Dark = {
		Background = Color3.fromRGB(30, 30, 30),
		TopBar = Color3.fromRGB(25, 25, 25),
		Tab = Color3.fromRGB(35, 35, 35),
		Button = Color3.fromRGB(50, 50, 50),
		TextColor = Color3.new(1, 1, 1),
		Accent = Color3.fromRGB(200, 50, 50)
	},
	White = {
		Background = Color3.fromRGB(245, 245, 245),
		TopBar = Color3.fromRGB(230, 230, 230),
		Tab = Color3.fromRGB(220, 220, 220),
		Button = Color3.fromRGB(200, 200, 200),
		TextColor = Color3.new(0, 0, 0),
		Accent = Color3.fromRGB(255, 100, 100)
	},
	["3D"] = {
		Background = Color3.fromRGB(60, 60, 60),
		TopBar = Color3.fromRGB(45, 45, 45),
		Tab = Color3.fromRGB(50, 50, 50),
		Button = Color3.fromRGB(70, 70, 70),
		TextColor = Color3.new(1, 1, 1),
		Accent = Color3.fromRGB(255, 70, 70)
	}
}

function Library:CreateWindow(settings)
	settings = settings or {}
	local WindowTitle = settings.Title or "Klx UI"
	local MainGui = Instance.new("ScreenGui", game.Players.LocalPlayer:WaitForChild("PlayerGui"))
	MainGui.Name = "KlxUILibrary"
	MainGui.ResetOnSpawn = false

	for _, gui in ipairs(game.Players.LocalPlayer.PlayerGui:GetChildren()) do
		if gui:IsA("ScreenGui") and gui.Name == "KlxUILibrary" and gui ~= MainGui then
			gui:Destroy()
		end
	end

	-- Elementos para controle de tema
	local elements = {
		Main = nil,
		TopBar = nil,
		CloseButton = nil,
		Tabs = {},
		Buttons = {},
		Texts = {}
	}

	-- Intro animada
	local IntroFrame = Instance.new("Frame", MainGui)
	IntroFrame.Size = UDim2.new(0, 300, 0, 80)
	IntroFrame.Position = UDim2.new(0.5, -150, 0.5, -40)
	IntroFrame.BackgroundTransparency = 1

	local IntroText = Instance.new("TextLabel", IntroFrame)
	IntroText.Size = UDim2.new(1, 0, 1, 0)
	IntroText.BackgroundTransparency = 1
	IntroText.Text = "KLX UI"
	IntroText.TextColor3 = Color3.new(1, 1, 1)
	IntroText.TextStrokeTransparency = 0.5
	IntroText.Font = Enum.Font.GothamBlack
	IntroText.TextScaled = true
	IntroText.TextTransparency = 1

	TweenService:Create(IntroText, TweenInfo.new(1), { TextTransparency = 0 }):Play()
	task.wait(2)
	TweenService:Create(IntroText, TweenInfo.new(1), { TextTransparency = 1 }):Play()
	task.wait(1)
	IntroFrame:Destroy()

	local ToggleBtn = Instance.new("TextButton", MainGui)
	ToggleBtn.Size = UDim2.new(0, 100, 0, 35)
	ToggleBtn.Position = UDim2.new(0, 10, 0, 10)
	ToggleBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
	ToggleBtn.Text = "Abrir Klx UI"
	ToggleBtn.TextColor3 = Color3.new(1, 1, 1)
	ToggleBtn.Font = Enum.Font.Gotham
	ToggleBtn.TextSize = 14
	Roundify(ToggleBtn, 8)
	MakeDraggable(ToggleBtn)

	local MainFrame = Instance.new("Frame", MainGui)
	MainFrame.Size = UDim2.new(0, 500, 0, 320)
	MainFrame.Position = UDim2.new(0.5, -250, 0.5, -160)
	MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
	MainFrame.BorderSizePixel = 0
	MainFrame.ClipsDescendants = true
	Roundify(MainFrame, 12)
	MainFrame.Visible = false
	MakeDraggable(MainFrame)

	ToggleBtn.MouseButton1Click:Connect(function()
		MainFrame.Visible = not MainFrame.Visible
	end)

	elements.Main = MainFrame

	local TopBar = Instance.new("Frame", MainFrame)
	TopBar.Size = UDim2.new(1, 0, 0, 40)
	TopBar.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
	TopBar.BorderSizePixel = 0
	Roundify(TopBar, 12)
	elements.TopBar = TopBar

	local Title = Instance.new("TextLabel", TopBar)
	Title.Text = WindowTitle
	Title.Size = UDim2.new(1, -80, 1, 0)
	Title.Position = UDim2.new(0, 10, 0, 0)
	Title.BackgroundTransparency = 1
	Title.TextColor3 = Color3.new(1, 1, 1)
	Title.TextXAlignment = Enum.TextXAlignment.Left
	Title.Font = Enum.Font.GothamSemibold
	Title.TextSize = 16
	table.insert(elements.Texts, Title)

	local CloseButton = Instance.new("TextButton", TopBar)
	CloseButton.Text = "X"
	CloseButton.Size = UDim2.new(0, 30, 0, 30)
	CloseButton.Position = UDim2.new(1, -35, 0.5, -15)
	CloseButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
	CloseButton.TextColor3 = Color3.new(1, 1, 1)
	CloseButton.Font = Enum.Font.Gotham
	CloseButton.TextSize = 14
	Roundify(CloseButton, 6)
	elements.CloseButton = CloseButton
	table.insert(elements.Texts, CloseButton)

	CloseButton.MouseButton1Click:Connect(function()
		TweenService:Create(MainFrame, TweenInfo.new(0.3), { Size = UDim2.new(0, 0, 0, 0) }):Play()
		task.wait(0.3)
		MainGui:Destroy()
	end)

	local TabList = Instance.new("Frame", MainFrame)
	TabList.Size = UDim2.new(0, 100, 1, -40)
	TabList.Position = UDim2.new(0, 0, 0, 40)
	TabList.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
	TabList.BorderSizePixel = 0

	local UIList = Instance.new("UIListLayout", TabList)
	UIList.SortOrder = Enum.SortOrder.LayoutOrder
	UIList.Padding = UDim.new(0, 4)

	local Tabs = {}

	function Library:CreateTab(tabName)
		local TabButton = Instance.new("TextButton", TabList)
		TabButton.Size = UDim2.new(1, 0, 0, 30)
		TabButton.Text = tabName
		TabButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
		TabButton.TextColor3 = Color3.new(1, 1, 1)
		TabButton.Font = Enum.Font.Gotham
		TabButton.TextSize = 14
		Roundify(TabButton, 4)
		table.insert(elements.Buttons, TabButton)
		table.insert(elements.Texts, TabButton)

		local TabFrame = Instance.new("ScrollingFrame", MainFrame)
		TabFrame.Size = UDim2.new(1, -110, 1, -50)
		TabFrame.Position = UDim2.new(0, 105, 0, 45)
		TabFrame.Visible = false
		TabFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
		TabFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
		TabFrame.BorderSizePixel = 0
		TabFrame.ScrollBarThickness = 6
		table.insert(elements.Tabs, TabFrame)

		local layout = Instance.new("UIListLayout", TabFrame)
		layout.Padding = UDim.new(0, 6)
		layout.SortOrder = Enum.SortOrder.LayoutOrder

		layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
			TabFrame.CanvasSize = UDim2.new(0, 0, 0, layout.AbsoluteContentSize.Y + 10)
		end)

		TabButton.MouseButton1Click:Connect(function()
			for _, tab in pairs(Tabs) do
				tab.Frame.Visible = false
			end
			TabFrame.Visible = true
		end)

		Tabs[tabName] = { Button = TabButton, Frame = TabFrame }

		local tabObj = {}

		function tabObj:CreateButton(text, callback)
			local button = Instance.new("TextButton", TabFrame)
			button.Size = UDim2.new(1, -10, 0, 30)
			button.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
			button.TextColor3 = Color3.new(1, 1, 1)
			button.Text = text
			button.Font = Enum.Font.Gotham
			button.TextSize = 14
			button.BorderSizePixel = 0
			Roundify(button, 6)
			table.insert(elements.Buttons, button)
			table.insert(elements.Texts, button)

			button.MouseButton1Click:Connect(function()
				if callback then callback() end
			end)

			return button
		end

		return tabObj
	end

	function Library:SetTheme(themeName)
		local theme = Themes[themeName]
		if not theme then return end

		elements.Main.BackgroundColor3 = theme.Background
		if elements.TopBar then elements.TopBar.BackgroundColor3 = theme.TopBar end
		if elements.CloseButton then
			elements.CloseButton.BackgroundColor3 = theme.Accent
			elements.CloseButton.TextColor3 = theme.TextColor
		end

		for _, tab in ipairs(elements.Tabs) do
			tab.BackgroundColor3 = theme.Tab
		end
		for _, btn in ipairs(elements.Buttons) do
			btn.BackgroundColor3 = theme.Button
		end
		for _, text in ipairs(elements.Texts) do
			text.TextColor3 = theme.TextColor
		end
	end

	local configTab = Library:CreateTab("Config")
	configTab:CreateButton("Tema Dark", function()
		Library:SetTheme("Dark")
	end)
	configTab:CreateButton("Tema White", function()
		Library:SetTheme("White")
	end)
	configTab:CreateButton("Tema 3D", function()
		Library:SetTheme("3D")
	end)

	Library:SetTheme("Dark")
	return Library
end

return Library:CreateWindow({ Title = "Klx UI" })
