--[[ 
    NEXUS UI LIBRARY V2 - REMASTERED
    Features: Temas, Slider Bolinha, Animação Suave, Anti-Duplicação
]]

local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")

local Nexus = {}

-- Configuração de Temas
local Themes = {
    Dark = {
        Main = Color3.fromRGB(25, 25, 30),
        Second = Color3.fromRGB(35, 35, 40),
        Accent = Color3.fromRGB(120, 120, 120),
        Text = Color3.fromRGB(240, 240, 240),
        Stroke = Color3.fromRGB(50, 50, 50)
    },
    Light = {
        Main = Color3.fromRGB(240, 240, 240),
        Second = Color3.fromRGB(255, 255, 255),
        Accent = Color3.fromRGB(0, 140, 255),
        Text = Color3.fromRGB(50, 50, 50),
        Stroke = Color3.fromRGB(200, 200, 200)
    },
    Blue = {
        Main = Color3.fromRGB(20, 25, 35),
        Second = Color3.fromRGB(30, 35, 45),
        Accent = Color3.fromRGB(0, 170, 255),
        Text = Color3.fromRGB(255, 255, 255),
        Stroke = Color3.fromRGB(0, 100, 180)
    },
    Red = {
        Main = Color3.fromRGB(30, 20, 20),
        Second = Color3.fromRGB(40, 25, 25),
        Accent = Color3.fromRGB(255, 60, 60),
        Text = Color3.fromRGB(255, 255, 255),
        Stroke = Color3.fromRGB(150, 40, 40)
    },
    Purple = {
        Main = Color3.fromRGB(30, 20, 35),
        Second = Color3.fromRGB(40, 25, 45),
        Accent = Color3.fromRGB(170, 80, 255),
        Text = Color3.fromRGB(255, 255, 255),
        Stroke = Color3.fromRGB(100, 50, 150)
    }
}

local function MakeDraggable(topbarobject, object)
    local Dragging = nil
    local DragInput = nil
    local DragStart = nil
    local StartPosition = nil

    local function Update(input)
        local Delta = input.Position - DragStart
        local newPos = UDim2.new(StartPosition.X.Scale, StartPosition.X.Offset + Delta.X, StartPosition.Y.Scale, StartPosition.Y.Offset + Delta.Y)
        TweenService:Create(object, TweenInfo.new(0.15, Enum.EasingStyle.Quad), {Position = newPos}):Play()
    end

    topbarobject.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            Dragging = true
            DragStart = input.Position
            StartPosition = object.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then Dragging = false end
            end)
        end
    end)
    topbarobject.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then DragInput = input end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == DragInput and Dragging then Update(input) end
    end)
end

function Nexus:Window(options)
    local TitleText = options.Name or "Nexus UI"
    local SelectedTheme = Themes[options.Theme] or Themes.Dark -- Default Dark

    -- SISTEMA INTELIGENTE DE FECHAR O ANTIGO
    -- Se já existir uma interface, animamos ela fechando antes de destruir
    local oldGui = CoreGui:FindFirstChild("NexusLibrary")
    if oldGui then
        local oldMain = oldGui:FindFirstChild("MainFrame")
        if oldMain then
            -- Animação de saida suave
            TweenService:Create(oldMain, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
                Size = UDim2.new(0, 450, 0, 0), -- Achata
                BackgroundTransparency = 1
            }):Play()
            task.wait(0.25)
        end
        oldGui:Destroy()
    end

    -- Criação da GUI
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "NexusLibrary"
    if gethui then
        ScreenGui.Parent = gethui()
    elseif syn and syn.protect_gui then
        syn.protect_gui(ScreenGui)
        ScreenGui.Parent = CoreGui
    else
        ScreenGui.Parent = CoreGui
    end
    
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    -- Janela Principal
    local MainFrame = Instance.new("Frame")
    MainFrame.Name = "MainFrame"
    MainFrame.Parent = ScreenGui
    MainFrame.BackgroundColor3 = SelectedTheme.Main
    MainFrame.Position = UDim2.new(0.5, -225, 0.5, -160)
    MainFrame.Size = UDim2.new(0, 450, 0, 0) -- Começa fechado para animação
    MainFrame.ClipsDescendants = true
    
    local MainCorner = Instance.new("UICorner")
    MainCorner.CornerRadius = UDim.new(0, 10)
    MainCorner.Parent = MainFrame
    
    local MainStroke = Instance.new("UIStroke")
    MainStroke.Parent = MainFrame
    MainStroke.Color = SelectedTheme.Stroke
    MainStroke.Thickness = 1.5
    MainStroke.Transparency = 1 -- Começa invisivel

    -- Animação de Abertura (Suave, sem pulo feio)
    local OpenTween = TweenService:Create(MainFrame, TweenInfo.new(0.5, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {Size = UDim2.new(0, 450, 0, 320)})
    OpenTween:Play()
    TweenService:Create(MainStroke, TweenInfo.new(0.5), {Transparency = 0}):Play()

    -- Botão de Minimizar (Mobile/PC)
    local ToggleBtn = Instance.new("TextButton")
    ToggleBtn.Name = "ToggleUI"
    ToggleBtn.Parent = ScreenGui
    ToggleBtn.BackgroundColor3 = SelectedTheme.Main
    ToggleBtn.Position = UDim2.new(0.02, 0, 0.15, 0)
    ToggleBtn.Size = UDim2.new(0, 40, 0, 40)
    ToggleBtn.Text = "UI"
    ToggleBtn.TextColor3 = SelectedTheme.Accent
    ToggleBtn.Font = Enum.Font.GothamBold
    ToggleBtn.TextSize = 14
    Instance.new("UICorner", ToggleBtn).CornerRadius = UDim.new(0, 8)
    local ToggleStroke = Instance.new("UIStroke")
    ToggleStroke.Parent = ToggleBtn
    ToggleStroke.Color = SelectedTheme.Stroke
    ToggleStroke.Thickness = 1.5
    MakeDraggable(ToggleBtn, ToggleBtn)

    local uiOpen = true
    ToggleBtn.MouseButton1Click:Connect(function()
        uiOpen = not uiOpen
        if uiOpen then
            MainFrame.Visible = true
            TweenService:Create(MainFrame, TweenInfo.new(0.4, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {Size = UDim2.new(0, 450, 0, 320)}):Play()
        else
            TweenService:Create(MainFrame, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {Size = UDim2.new(0, 450, 0, 0)}):Play()
            task.wait(0.3)
            if not uiOpen then MainFrame.Visible = false end
        end
    end)

    -- Topbar
    local Topbar = Instance.new("Frame")
    Topbar.Parent = MainFrame
    Topbar.BackgroundColor3 = Color3.new(1,1,1)
    Topbar.BackgroundTransparency = 1
    Topbar.Size = UDim2.new(1, 0, 0, 40)
    MakeDraggable(Topbar, MainFrame)

    local Title = Instance.new("TextLabel")
    Title.Parent = Topbar
    Title.BackgroundTransparency = 1
    Title.Position = UDim2.new(0, 20, 0, 0)
    Title.Size = UDim2.new(1, -40, 1, 0)
    Title.Font = Enum.Font.GothamBold
    Title.Text = TitleText
    Title.TextColor3 = SelectedTheme.Text
    Title.TextSize = 18
    Title.TextXAlignment = Enum.TextXAlignment.Left

    local Separator = Instance.new("Frame")
    Separator.Parent = MainFrame
    Separator.BackgroundColor3 = SelectedTheme.Stroke
    Separator.BorderSizePixel = 0
    Separator.Position = UDim2.new(0, 0, 0, 40)
    Separator.Size = UDim2.new(1, 0, 0, 1)

    -- Containers
    local TabContainer = Instance.new("ScrollingFrame")
    TabContainer.Parent = MainFrame
    TabContainer.BackgroundColor3 = SelectedTheme.Second
    TabContainer.Position = UDim2.new(0, 10, 0, 50)
    TabContainer.Size = UDim2.new(0, 110, 1, -60)
    TabContainer.ScrollBarThickness = 0
    TabContainer.BorderSizePixel = 0
    Instance.new("UICorner", TabContainer).CornerRadius = UDim.new(0, 8)
    
    local TabList = Instance.new("UIListLayout")
    TabList.Parent = TabContainer
    TabList.Padding = UDim.new(0,5)
    TabList.SortOrder = Enum.SortOrder.LayoutOrder
    TabList.HorizontalAlignment = Enum.HorizontalAlignment.Center

    -- Padding para o topo da lista de abas
    local TabPad = Instance.new("UIPadding")
    TabPad.Parent = TabContainer
    TabPad.PaddingTop = UDim.new(0, 5)

    local PageContainer = Instance.new("Frame")
    PageContainer.Parent = MainFrame
    PageContainer.BackgroundTransparency = 1
    PageContainer.Position = UDim2.new(0, 130, 0, 50)
    PageContainer.Size = UDim2.new(1, -140, 1, -60)

    local Tabs = {}
    local First = true

    function Tabs:Tab(name)
        -- Botão da Aba
        local TabBtn = Instance.new("TextButton")
        TabBtn.Parent = TabContainer
        TabBtn.BackgroundColor3 = SelectedTheme.Main
        TabBtn.BackgroundTransparency = 1 -- Começa transparente
        TabBtn.Size = UDim2.new(0, 100, 0, 32)
        TabBtn.Font = Enum.Font.GothamMedium
        TabBtn.Text = name
        TabBtn.TextColor3 = Color3.fromRGB(150,150,150)
        TabBtn.TextSize = 13
        Instance.new("UICorner", TabBtn).CornerRadius = UDim.new(0, 6)

        -- Página
        local Page = Instance.new("ScrollingFrame")
        Page.Parent = PageContainer
        Page.BackgroundTransparency = 1
        Page.Size = UDim2.new(1, 0, 1, 0)
        Page.ScrollBarThickness = 2
        Page.ScrollBarImageColor3 = SelectedTheme.Accent
        Page.Visible = false
        
        local PageList = Instance.new("UIListLayout")
        PageList.Parent = Page
        PageList.Padding = UDim.new(0, 6)
        PageList.SortOrder = Enum.SortOrder.LayoutOrder

        if First then
            First = false
            Page.Visible = true
            TabBtn.TextColor3 = SelectedTheme.Accent
            TabBtn.BackgroundTransparency = 0.9 -- Leve fundo
            TabBtn.BackgroundColor3 = SelectedTheme.Accent
        end

        TabBtn.MouseButton1Click:Connect(function()
            -- Resetar outros botões
            for _,v in pairs(TabContainer:GetChildren()) do 
                if v:IsA("TextButton") then 
                    TweenService:Create(v, TweenInfo.new(0.3), {TextColor3 = Color3.fromRGB(150,150,150), BackgroundTransparency = 1}):Play()
                end 
            end
            -- Esconder outras páginas
            for _,v in pairs(PageContainer:GetChildren()) do if v:IsA("ScrollingFrame") then v.Visible=false end end
            
            -- Ativar atual
            Page.Visible = true
            TweenService:Create(TabBtn, TweenInfo.new(0.3), {TextColor3 = SelectedTheme.Accent, BackgroundTransparency = 0.9, BackgroundColor3 = SelectedTheme.Accent}):Play()
        end)

        local Items = {}

        function Items:Button(text, callback)
            local BtnFrame = Instance.new("TextButton")
            BtnFrame.Parent = Page
            BtnFrame.BackgroundColor3 = SelectedTheme.Second
            BtnFrame.Size = UDim2.new(1, -5, 0, 36)
            BtnFrame.AutoButtonColor = false
            BtnFrame.Text = ""
            Instance.new("UICorner", BtnFrame).CornerRadius = UDim.new(0, 6)
            
            local BtnStroke = Instance.new("UIStroke")
            BtnStroke.Parent = BtnFrame
            BtnStroke.Color = SelectedTheme.Stroke
            BtnStroke.Thickness = 1
            BtnStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border

            local BtnText = Instance.new("TextLabel")
            BtnText.Parent = BtnFrame
            BtnText.BackgroundTransparency = 1
            BtnText.Size = UDim2.new(1, 0, 1, 0)
            BtnText.Text = text
            BtnText.TextColor3 = SelectedTheme.Text
            BtnText.Font = Enum.Font.Gotham
            BtnText.TextSize = 13

            BtnFrame.MouseButton1Click:Connect(function()
                TweenService:Create(BtnFrame, TweenInfo.new(0.1), {BackgroundColor3 = SelectedTheme.Accent}):Play()
                task.wait(0.1)
                TweenService:Create(BtnFrame, TweenInfo.new(0.3), {BackgroundColor3 = SelectedTheme.Second}):Play()
                pcall(callback)
            end)
        end

        function Items:Toggle(text, default, callback)
            local Toggled = default or false
            local ToggleFrame = Instance.new("Frame")
            ToggleFrame.Parent = Page
            ToggleFrame.BackgroundColor3 = SelectedTheme.Second
            ToggleFrame.Size = UDim2.new(1, -5, 0, 36)
            Instance.new("UICorner", ToggleFrame).CornerRadius = UDim.new(0, 6)
            
            local TStroke = Instance.new("UIStroke")
            TStroke.Parent = ToggleFrame
            TStroke.Color = SelectedTheme.Stroke
            TStroke.Thickness = 1

            local Label = Instance.new("TextLabel")
            Label.Parent = ToggleFrame
            Label.BackgroundTransparency = 1
            Label.Size = UDim2.new(0.7, 0, 1, 0)
            Label.Position = UDim2.new(0, 10, 0, 0)
            Label.TextXAlignment = Enum.TextXAlignment.Left
            Label.Text = text
            Label.TextColor3 = SelectedTheme.Text
            Label.Font = Enum.Font.Gotham
            Label.TextSize = 13

            -- O container do "switch"
            local SwitchBg = Instance.new("Frame")
            SwitchBg.Parent = ToggleFrame
            SwitchBg.Size = UDim2.new(0, 40, 0, 20)
            SwitchBg.Position = UDim2.new(1, -50, 0.5, -10)
            SwitchBg.BackgroundColor3 = Toggled and SelectedTheme.Accent or Color3.fromRGB(60,60,60)
            Instance.new("UICorner", SwitchBg).CornerRadius = UDim.new(1, 0)

            -- A bolinha do switch
            local SwitchDot = Instance.new("Frame")
            SwitchDot.Parent = SwitchBg
            SwitchDot.Size = UDim2.new(0, 16, 0, 16)
            SwitchDot.Position = Toggled and UDim2.new(1, -18, 0.5, -8) or UDim2.new(0, 2, 0.5, -8)
            SwitchDot.BackgroundColor3 = Color3.fromRGB(255,255,255)
            Instance.new("UICorner", SwitchDot).CornerRadius = UDim.new(1, 0)

            local Trigger = Instance.new("TextButton")
            Trigger.Parent = ToggleFrame
            Trigger.BackgroundTransparency = 1
            Trigger.Size = UDim2.new(1,0,1,0)
            Trigger.Text = ""

            Trigger.MouseButton1Click:Connect(function()
                Toggled = not Toggled
                local targetColor = Toggled and SelectedTheme.Accent or Color3.fromRGB(60,60,60)
                local targetPos = Toggled and UDim2.new(1, -18, 0.5, -8) or UDim2.new(0, 2, 0.5, -8)
                
                TweenService:Create(SwitchBg, TweenInfo.new(0.2), {BackgroundColor3 = targetColor}):Play()
                TweenService:Create(SwitchDot, TweenInfo.new(0.2, Enum.EasingStyle.Back), {Position = targetPos}):Play()
                
                pcall(callback, Toggled)
            end)
        end

        function Items:Slider(text, min, max, default, callback)
            local SliderFrame = Instance.new("Frame")
            SliderFrame.Parent = Page
            SliderFrame.BackgroundColor3 = SelectedTheme.Second
            SliderFrame.Size = UDim2.new(1, -5, 0, 50)
            Instance.new("UICorner", SliderFrame).CornerRadius = UDim.new(0, 6)
            
            local SStroke = Instance.new("UIStroke")
            SStroke.Parent = SliderFrame
            SStroke.Color = SelectedTheme.Stroke
            SStroke.Thickness = 1

            local Label = Instance.new("TextLabel")
            Label.Parent = SliderFrame
            Label.BackgroundTransparency = 1
            Label.Position = UDim2.new(0, 10, 0, 5)
            Label.Size = UDim2.new(1, -20, 0, 15)
            Label.TextXAlignment = Enum.TextXAlignment.Left
            Label.Text = text
            Label.TextColor3 = SelectedTheme.Text
            Label.Font = Enum.Font.Gotham
            Label.TextSize = 13

            local ValueLabel = Instance.new("TextLabel")
            ValueLabel.Parent = SliderFrame
            ValueLabel.BackgroundTransparency = 1
            ValueLabel.Position = UDim2.new(0, 10, 0, 5)
            ValueLabel.Size = UDim2.new(1, -20, 0, 15)
            ValueLabel.TextXAlignment = Enum.TextXAlignment.Right
            ValueLabel.Text = tostring(default)
            ValueLabel.TextColor3 = SelectedTheme.Accent
            ValueLabel.Font = Enum.Font.GothamBold
            ValueLabel.TextSize = 13

            -- Fundo da Barra
            local BarBG = Instance.new("Frame")
            BarBG.Parent = SliderFrame
            BarBG.BackgroundColor3 = Color3.fromRGB(40,40,45)
            BarBG.Position = UDim2.new(0, 10, 0, 30)
            BarBG.Size = UDim2.new(1, -20, 0, 4)
            Instance.new("UICorner", BarBG).CornerRadius = UDim.new(1, 0)

            -- Barra de Preenchimento
            local Fill = Instance.new("Frame")
            Fill.Parent = BarBG
            Fill.BackgroundColor3 = SelectedTheme.Accent
            local startP = (default - min)/(max - min)
            Fill.Size = UDim2.new(startP, 0, 1, 0)
            Instance.new("UICorner", Fill).CornerRadius = UDim.new(1, 0)

            -- A Bolinha (Knob)
            local Knob = Instance.new("Frame")
            Knob.Parent = BarBG
            Knob.BackgroundColor3 = Color3.fromRGB(255,255,255)
            Knob.Size = UDim2.new(0, 12, 0, 12)
            Knob.AnchorPoint = Vector2.new(0.5, 0.5)
            Knob.Position = UDim2.new(startP, 0, 0.5, 0) -- Centralizado na ponta
            Instance.new("UICorner", Knob).CornerRadius = UDim.new(1, 0)
            
            -- Sombra na bolinha (Opcional, mas bonito)
            local KnobStroke = Instance.new("UIStroke")
            KnobStroke.Parent = Knob
            KnobStroke.Color = SelectedTheme.Accent
            KnobStroke.Thickness = 1.5

            local Trigger = Instance.new("TextButton")
            Trigger.Parent = SliderFrame -- Trigger pega o frame todo pra ficar mais facil clicar
            Trigger.BackgroundTransparency = 1
            Trigger.Size = UDim2.new(1, 0, 1, 0)
            Trigger.Text = ""

            local dragging = false
            local function Update(input)
                local pos = input.Position.X
                local barAbsPos = BarBG.AbsolutePosition.X
                local barAbsSize = BarBG.AbsoluteSize.X
                
                local p = math.clamp((pos - barAbsPos) / barAbsSize, 0, 1)
                
                TweenService:Create(Fill, TweenInfo.new(0.05), {Size = UDim2.new(p, 0, 1, 0)}):Play()
                TweenService:Create(Knob, TweenInfo.new(0.05), {Position = UDim2.new(p, 0, 0.5, 0)}):Play()
                
                local val = math.floor(((p * (max - min)) + min) * 10) / 10
                ValueLabel.Text = tostring(val)
                pcall(callback, val)
            end

            Trigger.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                    dragging = true
                    Update(input)
                end
            end)
            UserInputService.InputChanged:Connect(function(input)
                if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                    Update(input)
                end
            end)
            UserInputService.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                    dragging = false
                end
            end)
        end

        return Items
    end
    return Tabs
end

return Nexus
